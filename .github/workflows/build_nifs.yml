name: Build Native NIFs
on:
  workflow_call:
    inputs:
      parent_matrix:
        required: true
        type: string
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      combined_matrix: ${{ steps.combine-matrices.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: "Invalidate Cache (Dummy Step)" # Keep for now.
        uses: actions/cache@v4
        with:
          path: .github/workflows
          key: matrix-generation-${{ github.run_id }}
      - name: Generate NIF Matrix
        id: generate-nif-matrix
        run: |
          # Inline the JSON for simplicity and to avoid file issues.
          PACKAGES='[
            { "name": "NIF_Package_1", "config": "config1", "repos": ["repo1", "repo2"] },
            { "name": "NIF_Package_2", "config": "config2", "repos": ["repo3"] }
          ]'

          # *** Corrected jq command ***
          MATRIX=$(echo "$PACKAGES" | jq -c '.[] | { name: .name, config: .config, repos: .repos } | .repos[] | {package: .name, repo: ., config: .config}')
          if [ $? -ne 0 ]; then
            echo "Error: jq command failed! (1)" >&2
            exit 1
          fi

          MATRIX_ARRAY=$(echo "[$MATRIX]" | jq -s .)
          if [ $? -ne 0 ]; then
            echo "Error: jq command failed! (2)" >&2
            exit 1
          fi
          echo "nif_matrix=$(echo "$MATRIX_ARRAY" | jq -c .)" >> "$GITHUB_OUTPUT"

      - name: Combine Matrices
        id: combine-matrices
        run: |
          PARENT_MATRIX='${{ inputs.parent_matrix }}'
          NIF_MATRIX=$(echo "${{ steps.generate-nif-matrix.outputs.nif_matrix }}")

          # Corrected jq to iterate over both platforms and NIF entries
          COMBINED_MATRIX=$(echo "$PARENT_MATRIX" | jq --argjson nif "$NIF_MATRIX" -c '
            .platform[] as $p | $nif[] | {platform: $p, package: .package, repo: .repo, config: .config}
          ')
          echo "matrix=$(echo "[$COMBINED_MATRIX]" | jq -s .)" >> "$GITHUB_OUTPUT"

  build-nifs:
    needs: generate-matrix
    runs-on: macos-latest  # Or your desired runner
    strategy:
      fail-fast: false  # Ensure all matrix combinations run even if some fail
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.combined_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build NIFs for ${{ matrix.platform.name }} - ${{ matrix.package }} - ${{ matrix.repo }}
        run: |
          echo "Building NIF package ${{ matrix.package }} for repo ${{ matrix.repo }} with config ${{ matrix.config }} (Platform: ${{ matrix.platform.name }})"
          mkdir -p "_build/nifs/${{ matrix.platform.id }}/${{ matrix.package }}/${{ matrix.repo }}"  # Corrected path
          echo "Building NIF package ${{ matrix.package }} for repo ${{ matrix.repo }} with config ${{ matrix.config }} (Platform: ${{ matrix.platform.name }})" > "_build/nifs/${{ matrix.platform.id }}/${{ matrix.package }}/${{ matrix.repo }}/msg.txt" # Corrected Path

      - name: Upload NIF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nif-${{ matrix.platform.id }}-${{ matrix.package }}-${{ matrix.repo }}  # Corrected name
          path: "_build/nifs/${{ matrix.platform.id }}/${{ matrix.package }}/${{ matrix.repo }}" # Corrected Path