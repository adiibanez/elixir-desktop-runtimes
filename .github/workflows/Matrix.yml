name: Build Apple targets liberlang.xframework
on:
  push:
    branches:
      - main
      - refactoring
  pull_request:
env:
  OPENSSL_VERSION: "3.4.0"
  OPENSSL_HASH: "002a2d6b30b58bf4bea46c43bdd96365aaf8daa6c428782aa4feee06da197df3"
jobs:
  build_setup:
    name: Setup Dependencies
    runs-on: macos-latest
    env:
      FRAMEWORK_NAME: "liberlang"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Cache ASDF and Toolchains
        uses: actions/cache@v4
        id: asdf-cache
        with:
          path: ~/.asdf
          key: asdf-cache-${{ runner.os }}-${{ hashFiles('.tool-versions') }}
          restore-keys: |
            asdf-cache-${{ runner.os }}-
      - name: Cache Openssl source
        uses: actions/cache@v4
        id: openssl-cache
        with:
          path: |
            openssl-${{ env.OPENSSL_VERSION }}
          key: openssl-source-cache-${{ env.OPENSSL_VERSION }}
      - name: Download and Extract OpenSSL
        if: steps.openssl-cache.outputs.cache-hit != 'true'
        id: openssl-download
        run: |
          wget "https://www.openssl.org/source/openssl-$OPENSSL_VERSION.tar.gz"
          # echo "$OPENSSL_HASH  openssl-$OPENSSL_VERSION.tar.gz" | sha256sum -c
          tar xzf openssl-$OPENSSL_VERSION.tar.gz
          ls -lah ${{github.workspace}}/openssl-$OPENSSL_VERSION

          echo "OPENSSL_VERSION=$OPENSSL_VERSION" >> "$GITHUB_OUTPUT"
          echo "OPENSSL_HASH=$OPENSSL_HASH" >> "$GITHUB_OUTPUT"
          echo "OPENSSL_PATH=$PWD/openssl-$OPENSSL_VERSION" >> "$GITHUB_OUTPUT"
  build_platform_matrix:
    name: Build - ${{ matrix.platform.name }} OTP${{ matrix.erlixir.otp-version }} ELX${{ matrix.erlixir.elixir-version }}
    runs-on: macos-latest
    needs: build_setup
    strategy:
      fail-fast: false
      matrix:
        erlixir:
          - {otp-version: 27.3, elixir-version: 1.18.2, erl-opts-description: "min;no-stripping;-year2038;-megaco", erl-opts: "--disable-stripped-runtime --disable-year2038 --disable-megaco-flex-scanner-lineno --disable-megaco-reentrant-flex-scanner --without-javac --without-odbc --without-wx --disable-sctp --disable-megaco --disable-corba", use-git: true, git-repo: "adiibanez/otp", git-ref: "OTP-27.3-noiosminversion"}
          - { otp-version: 26.2.5.6, elixir-version: 1.18.2, use-git: true, git-repo: "adiibanez/otp", git-ref: "OTP-26.2.5.6-noiosminversion"}
        os: [macos-latest]
        platform:

          # homebrew setting: no-ssl3 no-ssl3-method no-zlib
          # - {id: "macos_arm64", name: "macOS ARM64", sdk: macosx, arch: x86_64, openssl_arch: "darwin64-x86_64", otp_arch: "aarch64-darwin", xcomp: "aarch64-darwin"}
          - {id: "macos_arm64", name: "macOS arm64", sdk: macosx, arch: arm64, arch_type: macos, openssl_prefix: "_build/ios-openssl/build/openssl.macos.arm64", openssl_opts: "no-ssl3 no-ssl3-method no-zlib", openssl_arch: "darwin64-arm64", otp_arch: "aarch64-apple-darwin", xcomp: "aarch64-darwin"}
          - {id: "macos_x86_64", name: "macOS x86_64", sdk: macosx, arch: x86_64, arch_type: macos, openssl_prefix: "_build/ios-openssl/build/openssl.macos.x86_64", openssl_opts: "no-ssl3 no-ssl3-method no-zlib", openssl_arch: "darwin64-x86_64", otp_arch: "x86_64-apple-darwin", xcomp: "x86_64-darwin"}
          # ios: , xcomp: "arm64-ios"
          - {id: "ios", name: "iOS", sdk: iphoneos, arch: arm64, arch_type: ios, openssl_prefix: "_build/ios-openssl/build/openssl.ios", openssl_arch: "ios64-xcrun", otp_arch: "aarch64-apple-ios" , xcomp: "arm64-ios"}
          - {id: "ios_sim_arm64", name: "iOS Simulator arm64", sdk: iphonesimulator, arch: arm64, arch_type: ios_sim, openssl_prefix: "_build/ios-openssl/build/openssl.iossim.arm64", openssl_arch: "iossimulator-arm64-xcrun", otp_arch: "aarch64-apple-iossimulator", xcomp: "arm64-iossimulator" }
          - {id: "ios_sim_x86_64", name: "iOS Simulator x86_64", sdk: iphonesimulator, arch: x86_64, arch_type: ios_sim, openssl_prefix: "_build/ios-openssl/build/openssl.iossim.x86_64", openssl_arch: "iossimulator-x86_64-xcrun", otp_arch: "x86_64-apple-iossimulator", xcomp: "x86_64-iossimulator" }
          
          # - {id: "watchos", name: "watchOS", sdk: watchos, arch: arm64, openssl_arch: "ios64-xcrun", otp_arch: "aarch64-apple-ios", xcomp: "arm64-ios"}
          # - {id: "watchos_sim", name: "watchOS Simulator", sdk: watchsimulator, arch: x86_64, openssl_arch: "iossimulator-x86_64-xcrun", xcomp: "x86_64-iossimulator"}
          - {id: "tvos", name: "tvOS", sdk: appletvos, arch: arm64, arch_type: ios, openssl_prefix: "_build/ios-openssl/build/openssl.ios", openssl_arch: "ios64-xcrun", otp_arch: "aarch64-apple-ios", xcomp: "arm64-ios"}
          - {id: "tvos_sim_arm64", name: "tvOS Simulator arm64", sdk: appletvsimulator, arch: arm64, arch_type: ios_sim, openssl_prefix: "_build/ios-openssl/build/openssl.iossim.arm64", openssl_arch: "iossimulator-arm64-xcrun", otp_arch: "aarch64-apple-iossimulator", xcomp: "arm64-iossimulator"}
          - {id: "tvos_sim_x86_64", name: "tvOS Simulator x86_64", sdk: appletvsimulator, arch: x86_64, arch_type: ios_sim, openssl_prefix: "_build/ios-openssl/build/openssl.iossim.x86_64", openssl_arch: "iossimulator-x86_64-xcrun", otp_arch: "x86_64-apple-iossimulator", xcomp: "x86_64-iossimulator"}
          # - {id: "visionos", name: "visionOS", sdk: visionos, arch: arm64, openssl_arch: "ios64-xcrun", otp_arch: "aarch64-apple-ios", xcomp: "arm64-ios"}
          # # # - {id: "visionos_sim", name: "visionOS Simulator", sdk: visionsimulator, arch: x86_64, openssl_arch: "iossimulator-x86_64-xcrun", xcomp: "x86_64-iossimulator"}
          # - {id: "visionos", name: "visionOS", sdk: xros, arch: arm64, openssl_arch: "xros-xcrun", otp_arch: "aarch64-apple-ios", xcomp: "arm64-ios"}
          # - {id: "visionos_sim", name: "visionOS Simulator", sdk: xrsimulator, arch: arm64, openssl_arch: "xrossimulator-xcrun", otp_arch: "aarch64-apple-ios", xcomp: "arm64-iossimulator"}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Openssl source
        uses: actions/cache@v4
        id: openssl-source-cache
        with:
          path: |
            openssl-${{ env.OPENSSL_VERSION }}
          key: openssl-source-cache-${{ env.OPENSSL_VERSION }}
      - name: Cache Openssl builds
        uses: actions/cache@v4
        id: openssl-build-cache
        with:
          path: |
            openssl-${{ env.OPENSSL_VERSION }}
            _build/openssl-${{ env.OPENSSL_VERSION }}
          key: openssl-build-cache-${{ env.OPENSSL_VERSION }}-${{ runner.os }}-${{ matrix.platform.sdk }}-${{ matrix.platform.openssl_arch }}-${{ hashFiles('./scripts/install_openssl_new.sh') }}
          # restore-keys: |
          #   openssl-build-cache-${{ env.OPENSSL_VERSION }}-${{ runner.os }}-
          #   openssl-build-cache-${{ env.OPENSSL_VERSION }}-

      - name: Cache Openssl iOS builds
        uses: actions/cache@v4
        id: openssl-ios-build-cache
        with:
          path: |
            _build/ios-openssl
          key: openssl-ios-build-cache-${{ env.OPENSSL_VERSION }}-${{ runner.os }}-${{matrix.platform.arch_type}}-${{ hashFiles('./scripts/install_openssl_ios.sh') }}

      # - name: Build iOS OpenSSL
      #   if: steps.openssl-ios-build-cache.outputs.cache-hit != 'true'
      #   shell: bash
      #   run: |
      #     mkdir -p _build/ios-openssl
      #     cd openssl-${{ env.OPENSSL_VERSION }}
      #     OPENSSL_VERSION=${{ env.OPENSSL_VERSION }} BUILD_DIR=${{github.workspace}}/_build/ios-openssl ../scripts/install_openssl_ios.sh ${{matrix.platform.arch_type}}

      - name: build_openssl_ios
        uses: ./.github/actions/openssl-ios
        if: steps.openssl-ios-build-cache.outputs.cache-hit != 'true'
        with: 
          version: ${{env.OPENSSL_VERSION }}
          hash: ${{env.OPENSSL_HASH}}
          arch_type: ${{matrix.platform.arch_type }}

      - name: Check libs
        shell: bash
        env: 
          BUILD_DIR: ${{github.workspace}}/_build/ios-openssl
        run: |
          find $BUILD_DIR -name "*.a"
          find $BUILD_DIR -name "*.a" -exec lipo -info {} \;

      - name: Cache Openssl iOS build restore
        uses: actions/cache/restore@v4
        if: steps.openssl-ios-build-cache.outputs.cache-hit != 'true'
        id: openssl-ios-build-cache-restore
        with:
          path: |
            _build/ios-openssl
          key: openssl-ios-build-cache-${{ env.OPENSSL_VERSION }}-${{ runner.os }}-${{matrix.platform.arch_type}}-${{ hashFiles('./scripts/install_openssl_ios.sh') }}


      - name: Openssl Env
        shell: bash
        run: |
          echo "OPENSSL_PREFIX=${{ github.workspace }}/${{matrix.platform.openssl_prefix }}" >> "$GITHUB_ENV"
          #echo "OPENSSL_PREFIX=${{ github.workspace }}/_build/openssl-${{ env.OPENSSL_VERSION }}" >> "$GITHUB_ENV"
          echo "OPENSSL_SRC_PREFIX=${{ github.workspace }}/openssl-${{ env.OPENSSL_VERSION }}" >> "$GITHUB_ENV"
          


      - name: Build OpenSSL
        if: false
        id: openssl-build
        # if: steps.openssl-build-cache.outputs.cache-hit != 'true'
        run: |

          mkdir -p _build/openssl-${{ env.OPENSSL_VERSION }}
          # https://github.com/erlang/otp/issues/5706
          cp patch/openssl-ios.conf openssl-${{ env.OPENSSL_VERSION }}/Configurations/15-ios.conf
        
          # CXXFLAGS=$CFLAGS \
          # CFLAGS="-fno-common -Os -D__IOS__=yes" \
          # OPENSSL_OPTS="${{matrix.platform.openssl_opts}}" \
          # ARCH=${{ matrix.platform.openssl_arch }} \
          # MAKEFLAGS="-j10 -O" \
          # OPENSSL_PREFIX=${{ github.workspace }}/_build/openssl-${{ env.OPENSSL_VERSION }} \
          # ./scripts/install_openssl_new.sh

          # https://wiki.openssl.org/index.php/Compilation_and_Installation
          # # CXXFLAGS=$CFLAGS \
          # # CFLAGS="-fno-common -Os -D__IOS__=yes" \
          OPENSSL_OPTS="${{matrix.platform.openssl_opts}}" \
          SDKROOT=`xcrun -sdk ${{ matrix.platform.sdk }} --show-sdk-path` \
          CC="xcrun -sdk ${{ matrix.platform.sdk }} cc" \
          CXX="xcrun -sdk ${{ matrix.platform.sdk }} c++" \
          LD="xcrun -sdk ${{ matrix.platform.sdk }} ld" \
          LDFLAGS="-L$SDKROOT/usr/lib/ -lc++ -v" \
          DED_LD=$LD \
          DED_LDFLAGS="-L$SDKROOT/usr/lib/ -r -v" \
          RANLIB="xcrun -sdk ${{ matrix.platform.sdk }} ranlib" \
          AR="xcrun -sdk ${{ matrix.platform.sdk }} ar" \
          ARCH=${{ matrix.platform.openssl_arch }} \
          MAKEFLAGS="-j10 -O" \
          OPENSSL_PREFIX=${{ github.workspace }}/_build/openssl-${{ env.OPENSSL_VERSION }} \
          ./scripts/install_openssl_new.sh        

          ls -lah _build/openssl-$OPENSSL_VERSION
          find _build/openssl-$OPENSSL_VERSION -name "*.a"

      - name: Configure erl options
        if: ${{ matrix.erlixir.erl-opts }} != ''
        run: |
          # echo KERL_CONFIGURE_OPTIONS="${{matrix.erlixir.erl-opts}}" >> "$GITHUB_ENV"
          # used for hashing cache key
          echo "${{matrix.erlixir.erl-opts}}" > .kerl_configuration_options
      - name: Setup asdf .tool-versions
        id: asdf-setup
        run: |
          echo "" > .tool-versions
          echo "erlang ${{matrix.erlixir.otp-version}}" >> .tool-versions
          echo "elixir ${{matrix.erlixir.elixir-version}}" >> .tool-versions
          echo PATH="$HOME/.asdf/shims:$HOME/.asdf/bin:$PATH" >> "$GITHUB_ENV"
      - name: Setup asdf
        uses: asdf-vm/actions/setup@master
      - name: asdf cache
        id: asdf-cache
        uses: actions/cache@v4
        with:
          path: ~/.asdf/
          key: ${{ runner.os }}-${{ hashFiles('**/.tool-versions', '.kerl_configuration_options') }}
      - name: Install CD tools from .tool-versions
        continue-on-error: true
        if: steps.asdf-cache.outputs.cache-hit != 'true'
        uses: asdf-vm/actions/install@master
      - name: Test asdf tools
        id: asdf-test
        run: |
          erl -version
          elixir --version
          mix --version
      - name: Ensure mix dependencies
        shell: bash
        run: mix deps.get

      # save even if later jobs fail
      - name: Cache ASDF and Toolchains
        uses: actions/cache/save@v4
        if: steps.asdf-cache.outputs.cache-hit != 'true'
        id: asdf-cache-save
        with:
          path: ~/.asdf
          key: asdf-cache-${{ runner.os }}-${{ hashFiles('.tool-versions') }}
          restore-keys: |
            asdf-cache-${{ runner.os }}-

      - name: OTP Cache
        uses: actions/cache@v3
        id: otp-cache
        with:
          path: |
            otp_src_${{matrix.erlixir.otp-version}}
            _build/otp_release_${{matrix.erlixir.otp-version}}
            _build/otp_builder
          key: macos-otp-${{ matrix.platform.id }}-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts-description }}
          # restore-keys: |
          #   macos-otp-${{ matrix.platform.id }}-${{ matrix.erlixir.otp-version }}-
          #   macos-otp-
      - name: Download OTP 
        shell: bash
        if: steps.otp-cache.outputs.cache-hit != 'true'
        run: |
          USE_GIT="${{ matrix.erlixir.use-git }}"

          if [ -e otp_src_${{matrix.erlixir.otp-version}} ]; then
            exit 0
            rm -rf otp_src_${{matrix.erlixir.otp-version}}
          fi
          
          if [[ "$USE_GIT" == "true" ]]; then 
            # --branch OTP-${{matrix.erlixir.otp-version}}
            git clone --depth 1 https://github.com/${{matrix.erlixir.git-repo}} --branch ${{matrix.erlixir.git-ref}} otp_src_${{matrix.erlixir.otp-version}}
          else 
            curl -L -O https://github.com/erlang/otp/releases/download/OTP-${{matrix.erlixir.otp-version}}/otp_src_${{matrix.erlixir.otp-version}}.tar.gz
            tar -xzf otp_src_${{matrix.erlixir.otp-version}}.tar.gz
          fi

      - name: Build OTP Round 1 (xcomp)
        id: otp-setup
        # if: false
        if: steps.otp-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |

          ulimit -n 65536
          # file "${{github.workspace}}/_build/openssl-${{ env.OPENSSL_VERSION }}/lib/libcrypto.a"
          # unsetÂ SDKROOT https://stackoverflow.com/questions/62118332/using-sys-root-for-iphonesimulator-but-targeting-macosx-warning-in-npm-insta

          #ls -lah _build/openssl-$OPENSSL_VERSION
          #ls -lah _build/

          # echo $CC
          STATIC_NIFS="${{ github.workspace }}/_build/otp_builder/lib/asn1/priv/lib/${{ matrix.platform.otp_arch }}/asn1rt_nif.a,${{github.workspace}}/_build/otp_builder/lib/crypto/priv/lib/${{ matrix.platform.otp_arch }}/crypto.a"

          # priv/lib/x86_64-apple-iossimulator/crypto.a
          echo $STATIC_NIFS

          mkdir -p _build

          # rm -rf _build/otp_builder
          if [ -e _build/otp_builder ]; then
              echo "Otp builder exists."
          else
              cp -r otp_src_${{matrix.erlixir.otp-version}} _build/otp_builder
          fi

          # echo `env` > /tmp/otp_cmd.sh
          ls -lah $OPENSSL_PREFIX/lib
          echo $OPENSSL_PREFIX

          if [ -e $OPENSSL_PREFIX ]; then
              echo "Openssl $OPENSSL_PREFIX exists."
              file "$OPENSSL_PREFIX/lib/libcrypto.a"
              lipo -info "$OPENSSL_PREFIX/lib/libcrypto.a"
              otool -L "$OPENSSL_PREFIX/lib/libcrypto.a"
          else
              echo "Openssl $OPENSSL_PREFIX doesn't exists."
              exit 1
          fi

          export OTP_PREFIX=${{github.workspace}}/_build/otp_${{matrix.erlixir.otp-version}}

          # echo KERL_CONFIGURE_OPTIONS="${{matrix.erlixir.kerl-opts}} --disable-debug --without-javac --without-odbc --without-wx --disable-sctp --disable-megaco --disable-corba --disable-hipe --disable-compiler --disable-kernel-poll" \
          # ERL_FLAGS="-smp disable" \
          # OTP_PREFIX=${{github.workspace}}/_build/otp_${{matrix.erlixir.otp-version}} \
          # LIBS="${{github.workspace}}/_build/openssl-${{ env.OPENSSL_VERSION }}/lib/libcrypto.a" \
          # RELEASE_LIBBEAM="yes" ./otp_build configure \
          # --xcomp-conf=xcomp/erl-xcomp-${{ matrix.platform.xcomp }}.conf \
          # --with-ssl=${{github.workspace}}/_build/openssl-${{ env.OPENSSL_VERSION }} \
          # --disable-dynamic-ssl-lib \
          # --enable-static-nifs="$STATIC_NIFS" >> /tmp/otp_cmd.sh
          
          #--prefix="${{ github.workspace }}/_build/otp_release_${{matrix.erlixir.otp-version}}"

          # MAKEFLAGS="-j10 -O" \
          # --host=${{ matrix.platform.xcomp }} \

          cp patch/erl-xcomp-*.conf _build/otp_builder/xcomp/
          cd _build/otp_builder
          
          # exit 1

          #KERL_CONFIGURE_DISABLE_APPLICATIONS=megaco,snmp,dialyzer,eldap,odbc,mnesia,otp_mibs,observer \
          #KERL_CONFIGURE_OPTIONS="${{matrix.erlixir.kerl-opts}} --disable-debug --without-javac --without-odbc --without-wx --disable-sctp --disable-megaco --disable-corba --disable-hipe --disable-compiler --disable-kernel-poll" \
          #ERL_FLAGS="-smp disable" \
          
          # KERL_CONFIGURE_DISABLE_APPLICATIONS=megaco,snmp,dialyzer,eldap,odbc,mnesia,otp_mibs,observer \
          # KERL_CONFIGURE_DISABLE_APPLICATIONS https://github.com/kerl/kerl/blob/master/kerl
          # https://www.erlang.org/docs/19/applications

          xcodebuild -showsdks
          xcrun --sdk ${{matrix.platform.sdk}} --show-sdk-path

          # export CC="xcrun -sdk iphoneos cc"
          # export CXX="xcrun -sdk iphoneos c++"
          # export CFLAGS="-arch arm64 -isysroot $(xcrun --sdk iphoneos --show-sdk-path) -mios-version-min=13.0"
          # export LDFLAGS="-L$(xcrun --sdk iphoneos --show-sdk-path)/usr/lib/ -lc++"

          echo 'int main() { return 0; }' > test_compiler.c
          xcrun -sdk iphoneos cc -arch arm64 -o test_compiler test_compiler.c
          #./test_compiler
          file test_compiler

          # CFLAGS="-I$INCLUDE_PATH" \
          # MAKEFLAGS="-j10 -O" \

          # XCOMP_HOST=${{matrix.platform.otp_arch}} \
          # XCOMP_SDK="${{matrix.platform.sdk}}" \
          # XCOMP_ARCH="${{matrix.platform.arch}}" \
          # ARCH=${{ matrix.platform.arch }} \
          
          
          KERL_CONFIGURE_OPTIONS="${{matrix.erlixir.kerl-opts}}" \
          ERL_FLAGS="-smp disable" \
          LDFLAGS="-L${{env.OPENSSL_PREFIX}}/lib -lcrypto" \
          INCLUDE_PATH="$OPENSSL_PREFIX/include" \
          LIB_PATH="$OPENSSL_PREFIX/lib" \
          LIB_CRYPTO="$LIB_PATH/libcrypto.a" \
          LIBS="${{ env.OPENSSL_PREFIX }}/lib/libcrypto.a" \
          OTP_PREFIX=${{github.workspace}}/_build/otp_${{matrix.erlixir.otp-version}} \
          RELEASE_LIBBEAM="yes" ./otp_build configure \
          --xcomp-conf=xcomp/erl-xcomp-${{matrix.platform.xcomp}}.conf \
          --disable-dynamic-ssl-lib \
          --with-ssl="${{ env.OPENSSL_PREFIX }}" \
          --enable-static-nifs="$STATIC_NIFS"
          
          # ${{ matrix.platform.xcomp }}
          # rm -rf /tmp/otp_builder
          # cp -r ./ /tmp/otp_builder

          # rm -rf /tmp/openssl_otp
          # cp -r $OPENSSL_PREFIX/ /tmp/openssl_otp

          ./otp_build boot -a
          ./otp_build release -a

          find . -type d -name release

          #ls -alh ${{ github.workspace }}/_build/otp_release_${{matrix.erlixir.otp-version}}

          find ~+ -name libbeam.a
          find ~+ -name asn1rt_nif.a
          find ~+ -name crypto.a

          cd ${{ github.workspace }}

          #ls -lah $OTP_PREFIX
          ls -lah _build/otp_builder

      - name: Show libs for ${{ matrix.platform.name }}
        if: always() && steps.otp-setup.outcome != 'success'
        shell: bash
        run: |
          find _build/otp_builder -name "*.a"

      - name: Extract logs for ${{ matrix.platform.name }}
        if: always() && steps.otp-setup.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}
          path: "**/*.log"

      - name: Combine static OTP libs
        continue-on-error: false
        shell: bash
        run: |
          BUILD_HOST=`_build/otp_builder/erts/autoconf/config.guess`
          echo "BUID_HOST: $BUILD_HOST"

          rm -f /tmp/libs.txt
          MIX_ENV=prod mix run -e "Mix.Tasks.Package.Ios.Runtime.filter_lib_files(\"${{ github.workspace }}/_build/otp_builder\", \"${{matrix.platform.otp_arch}}\", \"$BUILD_HOST\")"  2>/dev/null

          #echo mix run -e \"Mix.Tasks.Package.Ios.Runtime.filter_lib_files(\"${{ github.workspace }}/_build/otp_builder\", \"${{matrix.platform.otp_arch}}\", \"$BUILD_HOST\")"
          # LIBS=`MIX_ENV=prod mix run -e "Mix.Tasks.Package.Ios.Runtime.filter_lib_files(\"${{ github.workspace }}/_build/otp_builder\", \"${{matrix.platform.otp_arch}}\", \"$BUILD_HOST\")"  2>/dev/null`
          #exit 1
          
          LIBS="`cat /tmp/libs.txt` ${{env.OPENSSL_PREFIX}}/lib/libcrypto.a"

          cd _build/otp_builder
          # find . -name libbeam.a
          # cd ${{ github.workspace }}

          # cd _build/otp_builder/release/${{matrix.platform.otp_arch}}
          # cd _build/otp_builder/${{matrix.platform.otp_arch}}

          # find . -name libbeam.a
          # find . -name libcrypto.a
          # INCLUDE_PATTERN="_r.a|_s.a"
          # # https://askubuntu.com/questions/444551/get-absolute-path-of-files-using-find-command

          # find ~+ -type f -name "*.a" | grep -v "$BUILD_HOST" -e "${{matrix.platform.otp_arch}}" -E "$INCLUDE_PATTERN" | awk '{print " ls -alh " $1}' | sh

          # exit 1
          #  >> /tmp/lib_report.log
          #find ~+ -type f -name "*.a" | grep -E $INCLUDE_PATTERN | awk '{print " lipo -info " $1}' | sh >> /tmp/lib_report.log
          #find ~+ -type f -name "*.a" | grep -E $INCLUDE_PATTERN | awk '{print " otool -L " $1}' | sh >> /tmp/lib_report.log

          #rm -rf /tmp/otp_libs
          #mkdir /tmp/otp_libs
          #cp $LIBS /tmp/otp_libs

          # find ~+ -type f -name "*.a" | grep -v "$BUILD_HOST" -e "${{matrix.platform.otp_arch}}" -E "$INCLUDE_PATTERN" | awk '{print " cp " $1 " `basename " $1 "`"}' | sh

          # LIBS=`find ~+ -type f -name "*.a" | grep -v "$BUILD_HOST" -e "${{matrix.platform.otp_arch}}" -E "$INCLUDE_PATTERN" | awk '{printf " %s", $1} END { print "" }'`
          echo $LIBS

          #OUTPUT_LIB="${{ github.workspace }}/_build/liberlang_OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}.a"
          OUTPUT_LIB="${{ github.workspace }}/_build/liberlang.a"

          # ${{ github.workspace }}/_build/otp_builder/bin/${{matrix.platform.otp_arch}}/libbeam.a

          # xcrun -sdk ${{matrix.platform.sdk}} 
          rm -f $OUTPUT_LIB
          libtool -static -o $OUTPUT_LIB $LIBS
  
      - name: Check output lib
        shell: bash
        continue-on-error: true
        run: |
          file ${{ github.workspace }}/_build/liberlang.a
          lipo -info ${{ github.workspace }}/_build/liberlang.a
          # file ${{ github.workspace }}/_build/liberlang_OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}.a
          # lipo -info ${{ github.workspace }}/_build/liberlang_OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}.a

      - name: Upload liberlang.a libs Artifact for ${{ matrix.platform.name }}
        uses: actions/upload-artifact@v4
        with:
          name: debug-libs-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}-liberlang
          path: /tmp/otp_libs/*

      - name: Upload liberlang.a Artifact for ${{ matrix.platform.name }}
        uses: actions/upload-artifact@v4
        with:
          name: libs-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}-liberlang
          #path: _build/liberlang_OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}.a
          path: _build/liberlang.a
      
  #     - name: Set up Rust Toolchain (Nightly)
  #       uses: dtolnay/rust-toolchain@nightly
  #       with:
  #         targets: ${{ matrix.platform.rust_target }}

  #     - name: Build NIFs for ${{ matrix.platform.name }} OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}
  #       shell: bash
  #       env: 
  #         RUSTLER_BTLEPLUG_BUILD: 1
  #         WASMEX_BUILD: 1
  #         RUST_TARGET: ${{ matrix.platform.otp_arch }}
  #         RUSTFLAGS: "-C target-feature=+crt-static"
  #       run: |
  #         echo "Building NIFs for ${{ matrix.platform.name }} - ${{ matrix.platform.sdk }} - ${{ matrix.platform.arch }}"

  #         export SDKROOT="$(xcrun --sdk ${{ matrix.platform.sdk }} --show-sdk-path)"
  #         export CC="xcrun -sdk ${{ matrix.platform.sdk }} cc -arch arm64"
  #         export CFLAGS="-mios-version-min=11.0 -fno-common -Os -D__IOS__=yes"

  #         mkdir -p _build/nifs/
  #         cd _build/nifs/

  #         # git clone --depth 1 https://github.com/elixir-desktop/exqlite.git
  #         # cd exqlite
  #         # mix deps.get
  #         # mix release
  #         # cd ..

  #         # git clone --depth 1 https://github.com/diodechain/libsecp256k1.git
  #         # cd libsecp256k1
  #         # mix deps.get
  #         # mix release
  #         # cd ..

  #         git clone --depth 1 https://github.com/adiibanez/rustler_btleplug.git --branch v0.0.15-alpha
  #         cd rustler_btleplug
  #         mix deps.get
  #         mix release
  #         cd ..

  #         # git clone --depth 1 https://github.com/adiibanez/wasmex.git --branch main
  #         # cd wasmex
  #         # mix deps.get
  #         # mix release
  #         # cd ..

  #         # git clone --depth 1 https://github.com/adiibanez/explorer.git --branch main
  #         # cd explorer
  #         # mix deps.get
  #         # mix release
  #         # cd ..

  #         cd ${{ github.workspace }}

  #         find _build/nifs -type f -name "*.a"

  #     - name: Upload Nifs for ${{ matrix.platform.name }} OTP-${{matrix.erlixir.otp-version}} ELX-${{matrix.erlixir.elixir-version}}
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: libs-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}-nifs
  #         path: |
  #           _build/nifs/**/**.a

      - name: Download liberlang  ${{ matrix.platform.name }} OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}
        uses: actions/download-artifact@v4
        with:
          pattern: libs-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}-*
          #name: libs-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}-liberlang
          path: _build/libs
          merge-multiple: true

      # - name: Download Libs for ${{ matrix.platform.name }} OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}
      #   uses: actions/download-artifact@v4
      #   with:
      #     pattern: libs-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}-*
      #     path: _build/libs
      #     merge-multiple: true

      - name: Build liberlang.xcframework Slice for ${{ matrix.platform.name }} OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}
        shell: bash
        id: build-xcframework-slice
        run: |
          ls -lah ./
          ls -lah _build/libs
          INCLUDE_PATTERN=".a"
          
          echo LOOKUP_LIBS for liberlang.xcframework Slice
          find ~+ -type f -name "*.a" | grep -E $INCLUDE_PATTERN | awk '{print " ls -alh " $1}' | sh
          
          find ${{ github.workspace }}/_build/libs -type f -name "*.a" | grep -E $INCLUDE_PATTERN | awk '{print " ls -alh " $1}' | sh
          LIBS=`find ${{ github.workspace }}/_build/libs -type f -name "*.a" | grep -E $INCLUDE_PATTERN | awk '{printf " -library %s", $1} END { print "" }'`
          echo $LIBS

          echo "Building liberlang.xcframework slice for ${{ matrix.platform.name }}"
          mkdir liberlang_xcframework_slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}

          cd liberlang_xcframework_slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}

          xcodebuild -create-xcframework \
            -output liberlang.xcframework \
            $LIBS

          # cp -rf liberlang.xcframework /tmp/otp_libs/

          echo "xcframework_slice_path=liberlang_xcframework_slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}" >> "$GITHUB_OUTPUT"

      - name: Upload liberlang.xcframework Slice Artifact for ${{ matrix.platform.name }}
        uses: actions/upload-artifact@v4
        id: upload-xcframework-slice
        with:
          name: liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-${{ matrix.platform.id }}
          path: ${{ steps.build-xcframework-slice.outputs.xcframework_slice_path }}

  combine_xcframework:
    # if: false
    name: Combine XC Framework
    runs-on: macos-latest
    needs: build_platform_matrix
    strategy:
      fail-fast: false
      matrix:
        erlixir:
          - { otp-version: 27.3, elixir-version: 1.18.2, erl-opts-description: "-year2038;-megaco", erl-opts: "--disable-year2038 --disable-megaco-flex-scanner-lineno --disable-megaco-reentrant-flex-scanner", use-git: true, git-repo: "adiibanez/otp", git-ref: "OTP-27.3-noiosminversion"}
          - { otp-version: 26.2.5.6, elixir-version: 1.18.2, use-git: true, git-repo: "adiibanez/otp", git-ref: "OTP-26.2.5.6-noiosminversion"}
        os: [macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Download liberlang.xcframework Slice Artifacts
        uses: actions/download-artifact@v4
        with:
          path: xcframework-slices
          pattern: liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-*
          # merge-multiple: true

      - name: Setup Combined xcframework env
        shell: bash
        run: |

          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-macos_arm64/liberlang.xcframework/macos-arm64/liberlang.a
          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-tvos_sim_arm64/liberlang.xcframework/ios-arm64-simulator/liberlang.a
          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-ios_sim_arm64/liberlang.xcframework/ios-arm64-simulator/liberlang.a
          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-ios/liberlang.xcframework/ios-arm64/liberlang.a
          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-tvos_sim_x86_64/liberlang.xcframework/ios-x86_64-simulator/liberlang.a
          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-tvos/liberlang.xcframework/ios-arm64/liberlang.a
          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-macos_x86_64/liberlang.xcframework/macos-x86_64/liberlang.a
          # xcframework-slices/liberlang-xcframework-slice-OTP-27.3-ELX-1.18.2-ios_sim_x86_64/liberlang.xcframework/ios-x86_64-simulator/liberlang.a

          echo "MACOS_FRAMEWORK_ARM64=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-macos_arm64/liberlang.xcframework/macos-arm64/liberlang.a" >> $GITHUB_ENV
          echo "MACOS_FRAMEWORK_X86_64=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-macos_x86_64/liberlang.xcframework/macos-x86_64/liberlang.a" >> $GITHUB_ENV
          echo "IOS_FRAMEWORK=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-ios/liberlang.xcframework/ios-arm64/liberlang.a" >> $GITHUB_ENV
          echo "SIMULATOR_FRAMEWORK_ARM64=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-ios_sim_arm64/liberlang.xcframework/ios-arm64-simulator/liberlang.a" >> $GITHUB_ENV
          echo "SIMULATOR_FRAMEWORK_X86_64=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-ios_sim_x86_64/liberlang.xcframework/ios-x86_64-simulator/liberlang.a" >> $GITHUB_ENV
          echo "TVOS_FRAMEWORK=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-tvos/liberlang.xcframework/ios-arm64/liberlang.a" >> $GITHUB_ENV
          echo "TVOS_SIMULATOR_FRAMEWORK_ARM64=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-tvos_sim_arm64/liberlang.xcframework/ios-arm64-simulator/liberlang.a" >> $GITHUB_ENV
          echo "TVOS_SIMULATOR_FRAMEWORK_X86_64=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-ios_sim_x86_64/liberlang.xcframework/ios-x86_64-simulator/liberlang.a" >> $GITHUB_ENV

          # echo "WATCHOS_FRAMEWORK=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-watchos/liberlang.xcframework" >> $GITHUB_ENV
          # echo "WATCHOS_SIMULATOR_FRAMEWORK=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-watchos_sim/liberlang.xcframework" >> $GITHUB_ENV
          # echo "VISIONOS_FRAMEWORK=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-visionos/liberlang.xcframework/ios-arm64/liberlang.a" >> $GITHUB_ENV
          # echo "VISIONOS_SIMULATOR_FRAMEWORK=xcframework-slices/liberlang-xcframework-slice-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-visionos_sim/liberlang.xcframework/ios-x86_64-simulator/liberlang.a" >> $GITHUB_ENV

      - name: Collect Combined xcframework artifacts and lipo
        shell: bash
        run: |

          find xcframework-slices -name "*.a"

          lipo -create $MACOS_FRAMEWORK_ARM64 $MACOS_FRAMEWORK_X86_64 -output macos_lipo.a
          echo MACOS_FRAMEWORK=macos_lipo.a >> $GITHUB_ENV

          lipo -create $SIMULATOR_FRAMEWORK_ARM64 $SIMULATOR_FRAMEWORK_X86_64 -output ios_simulator_lipo.a
          echo SIMULATOR_FRAMEWORK=ios_simulator_lipo.a >> $GITHUB_ENV

          lipo -create $TVOS_SIMULATOR_FRAMEWORK_ARM64 $TVOS_SIMULATOR_FRAMEWORK_X86_64 -output tvos_simulator_lipo.a
          echo TVOS_SIMULATOR_FRAMEWORK=tvos_simulator_lipo.a >> $GITHUB_ENV

          FRAMEWORK_NAME=liberlang
          echo OUTPUT_XCFRAMEWORK=${FRAMEWORK_NAME}.xcframework >> $GITHUB_ENV

          #rm -rf /tmp/xcframework-slices
          #cp -r xcframework-slices /tmp/xcframework-slices

          ls -lah xcframework-slices
          find xcframework-slices -type d
          find xcframework-slices -type f -name "*.a"

          if [ -z "$IOS_FRAMEWORK" ]; then
            echo "iOS Framework $IOS_FRAMEWORK does not exist"
            exit 1
          fi

          if [ -z "$SIMULATOR_FRAMEWORK" ]; then
            echo "iOS Sim Framework $SIMULATOR_FRAMEWORK does not exist"
            exit 1
          fi
          
          mkdir /tmp/raw-artifacts
          cp $IOS_FRAMEWORK $MACOS_FRAMEWORK $SIMULATOR_FRAMEWORK $TVOS_FRAMEWORK $TVOS_SIMULATOR_FRAMEWORK /tmp/debug-artifacts/
          
      - name: Upload Raw xcframework Artifacts
        uses: actions/upload-artifact@v4
        if: always() && steps.assemble-xcframework.outcome != 'success'
        with:
          name: liberlang-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}-raw-lib-artifacts
          path: /tmp/raw-artifacts/
          
      - name: Assemble xcframework
          id: assemble-xcframework
          shell: bash
          continue-on-error: true
          run: |

          echo $IOS_FRAMEWORK
          echo $SIMULATOR_FRAMEWORK
          echo $OUTPUT_XCFRAMEWORK

          echo xcodebuild -create-xcframework \
            -library $IOS_FRAMEWORK \
            -library $SIMULATOR_FRAMEWORK \
            -library $MACOS_FRAMEWORK \
            -library $TVOS_SIMULATOR_FRAMEWORK \
            -output $OUTPUT_XCFRAMEWORK

          xcodebuild -create-xcframework \
            -library $IOS_FRAMEWORK \
            -library $SIMULATOR_FRAMEWORK \
            -library $MACOS_FRAMEWORK \
            -library $TVOS_SIMULATOR_FRAMEWORK \
            -output $OUTPUT_XCFRAMEWORK

          rm -rf /tmp/xcframwork_output
          cp -r $OUTPUT_XCFRAMEWORK /tmp/xcframwork_output/
          
          mkdir liberlang-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}
          mv $OUTPUT_XCFRAMEWORK liberlang-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}/

      - name: Check Architecture
        continue-on-error: true
        run: |
          #ls -lah liberlang.xframework
          #du -sh liberlang.xframework
          #lipo -info "$OUTPUT_XCFRAMEWORK/${FRAMEWORK_NAME}" || 1
          cd scripts
          LIB_ARM=$IOS_FRAMEWORK LIB_X86=$SIMULATOR_FRAMEWORK ./tester.sh
          
      - name: Upload Combined xcframework Artifact
        uses: actions/upload-artifact@v4
        if: steps.assemble-xcframework.outcome == 'success'
        with:
          name: liberlang-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}
          path: liberlang-OTP-${{matrix.erlixir.otp-version}}-ELX-${{matrix.erlixir.elixir-version}}
