name: "CI"
on:
  workflow_dispatch:
  push:
    branches: 
      - ci_mods
      - refactoring
    paths:
    # Just run on main branch if "native" path changed.
    #- "native/**"
    - "**"
    # Also run if this file changes.
    #- ".github/workflows/release.yml"
    #- ".github/workflows/**"
    tags:
    # Tags will always run.
    - "*"
  pull_request:
    paths:
      # In PRs we only run if this file changes.
      - ".github/workflows/**"

# concurrency:
#   group: ${{ github.workflow }}-${{ github.ref }}
#   cancel-in-progress: true

env:
  OTP_SOURCE: https://github.com/erlang/otp
  OPENSSL_HASH: 002a2d6b30b58bf4bea46c43bdd96365aaf8daa6c428782aa4feee06da197df3
  OPENSSL_VERSION: 3.4.1v

jobs:
  build-android:
    strategy:
      fail-fast: false
      matrix:
        archs:
          - { id: "arm",
            abi: 23,
            cpu: "arm",
            pc: "arm-unknown",
            name: "androideabi",
            type: "armeabi-v7a"
          }
          - {
            id: "arm64",
            abi: 23,
            cpu: "aarch64",
            pc: "aarch64-unknown",
            name: "android",
            type: "arm64-v8a"
          }
          - {
            id: "x86_64",
            abi: 23,
            cpu: "x86_64",
            pc: "x86_64-pc",
            name: "android",
            type: "x86_64"
          }
        erlixir:
          #- { otp-version: 27.2.4, elixir-version: 1.18.2, erl-opts: "--disable-year2038"}
          - { otp-version: 26.2.5.6, elixir-version: 1.16.3 }
          - { otp-version: 26.2.5.6, elixir-version: 1.18.2 }
    env:
      OTP_TAG: OTP-${{ matrix.erlixir.otp-version }}
      ARCH_IDENTIFIER: ${{matrix.archs.id}}-${{matrix.archs.name}}-${{matrix.archs.abi}}

    name: "Build Android runtimes"
    runs-on: "ubuntu-latest"

    steps:
      - name: Checkout opt ${{matrix.erlixir.otp-version}}
        uses: actions/checkout@v3
        with: 
          path: _build/otp_cache/otp
          repository: erlang/otp
          ref: ${{ env.OTP_TAG }}

      - name: Check otp 
        shell: bash
        run: |
          ls -lah _build/otp_cache/otp
          find _build/otp_cache/ -name vsn.mk
          pwd

      - name: Configure erl options
        if: ${{ matrix.erlixir.erl-opts }} != ''
        run: |
          export KERL_CONFIGURE_OPTIONS=${{matrix.erlixir.erl-opts}}

      - name: erlef/setup-beam Cache
        uses: actions/cache@v3
        id: beam-cache
        with:
          path: /home/runner/work/_temp/.setup-beam/
          key: android-setup-beam-${{env.ARCH_IDENTIFIER}}-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}

      - name: Setup elixir
        id: setup-beam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.erlixir.otp-version }}
          elixir-version: ${{ matrix.erlixir.elixir-version }}

      - name: Save erlef/setup-beam Cache
        if: steps.beam-cache.outputs.cache-hit != 'true' && steps.setup-beam.outcome == 'success'
        uses: actions/cache/save@v3
        with:
          path: /home/runner/work/_temp/.setup-beam/
          key: android-setup-beam-${{env.ARCH_IDENTIFIER}}-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}

      - name: Debug erlef/setup-beam install locations
        shell: bash
        run: |
          env | grep INSTALL_DIR_FOR_

      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}


      - name: Generate beam docker file
        id: generate-dockerfile
        shell: bash
        run: |
          pwd
          MIX_TARGET=prod mix compile
          mix run -e 'Mix.Tasks.Package.Android.Runtime.write_beam_dockerfile("${{matrix.archs.id}}", "${{github.workspace}}/_build/Dockerfile_android-beam-${{matrix.archs.id}}")'
          echo "${{github.workspace}}/_build/Dockerfile_android-beam-${{matrix.archs.id}}"
          ls -lah "_build/Dockerfile_android-beam-${{matrix.archs.id}}"
          cat "_build/Dockerfile_android-beam-${{matrix.archs.id}}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Linux docker android beam builder image
        uses: whoan/docker-build-with-cache-action@v5
        if: steps.generate-dockerfile.outcome == 'success'
        continue-on-error: true
        id: buildx-beam
        with:
          username: ${{ github.actor }}
          password: ${{secrets.GITHUB_TOKEN}}
          registry: ghcr.io
          image_name: android_beam
          image_tag: "arch_${{env.ARCH_IDENTIFIER}}-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}"
          dockerfile: "_build/Dockerfile_android-beam-${{matrix.archs.id}}"
          build_extra_args: |
            --platform=linux/amd64
            --build-arg ARCH=${{matrix.archs.id}}
            --build-arg ANDROID_NAME=${{matrix.archs.name}}
            --build-arg ABI=${{matrix.archs.abi}}
            --build-arg OPENSSL_VERSION=${{env.OPENSSL_VERSION}}
            --build-arg OPENSSL_HASH=${{env.OPENSSL_HASH}}
            --build-arg KERL_CONFIGURE_OPTIONS="${{matrix.erlixir.erl-opts}}"

      # - name: Linux docker android nif builder image
      #   uses: whoan/docker-build-with-cache-action@v5
      #   id: buildx-nif
      #   with:
      #     username: ${{ github.actor }}
      #     password: ${{secrets.GITHUB_TOKEN}}
      #     registry: ghcr.io
      #     image_name: android_beam
      #     image_tag: "arch_${{ matrix.job.arch}}-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}"
      #     dockerfile: scripts/Dockerfile_android_beam
      #     build_extra_args: |
      #       --build-arg PARENT_IMAGE= \
      #       --build-arg ANDROID_NAME="linux" \
      #       --build-arg ABI="21" \
      #       --build-arg KERL_CONFIGURE_OPTIONS="${{matrix.erlixir.erl-opts}}"

        # --build-arg=BASE_IMAGE=ubuntu:20.04
        # --platform=linux/amd64
        # --build-arg=PLATFORM=amd64
        # --build-arg=WXWIDGETS_REPO=${{ env.WXWIDGETS_REPO }}
        # --build-arg=WXWIDGETS_VERSION=${{ env.WXWIDGETS_VERSION }}
        # --build-arg=OTP_VERSION=${{ env.OTP_VERSION }}
        # --build-arg=OTP_GITHUB_URL=${{ env.OTP_GITHUB_URL }}
        # --build-arg=ELIXIR_VERSION=${{ env.ELIXIR_VERSION }}
        # --build-arg=ELIXIR_VARIANT=${{ env.ELIXIR_VARIANT }}

      
      - name: Build Android ${{env.ARCH_IDENTIFIER}} runtimes
        if: steps.buildx-beam.outcome == 'success'
        env: 
          ARCH: ${{matrix.archs.id}}
          BUILDER_IMAGE: ghcr.io/adiibanez/android_beam:arch_${{env.ARCH_IDENTIFIER}}-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}"
        run: |
          mix deps.get
          mix package.android.runtime
          mix package.android.nif # runs multiple iterations based on default_nifs

      - name: Docker images
        shell: bash
        run: |
          docker images
          # docker pull dockcross/android-${{env.ARCH_IDENTIFIER}}

      - name: Archive Android runtimes
        uses: actions/upload-artifact@v4
        with:
          name: android-${{env.ARCH_IDENTIFIER}}-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}-runtime.zip
          path: _build/*.zip

      - name: Generate Android Checksums and Release Notes
        id: android-checksums
        run: |
          cd _build
          # For GNU systems.
          if command -v sha256sum >/dev/null 2>&1; then
              find . -name "*.zip" -print0 | while IFS= read -r -d $'\0' file; do
                sha256sum "$file" >> checksums.txt
              done
          # For BSD systems
          else
              find . -name "*.zip" -print0 | while IFS= read -r -d $'\0' file; do
                shasum -a 256 "$file" >> checksums.txt
              done
          fi
          echo "::set-output name=android_checksums::$(cat checksums.txt)"
          cd ..

      - name: Android ${{env.ARCH_IDENTIFIER}} release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: _build/*.zip
          body: |
            Android Checksums:
            ${{ steps.android-checksums.outputs.android_checksums }}
  
  build-ios:
    if: false
    strategy:
      fail-fast: false
      matrix:
        erlixir:
          #- { otp-version: 27.2.4, elixir-version: 1.18.2, erl-opts: "--disable-year2038"} # configured in package_ios_runtime.ex too configuration
          - { otp-version: 26.2.5.6, elixir-version: 1.16.3 }
          - { otp-version: 26.2.5.6, elixir-version: 1.18.2 }
    env:
      OTP_TAG: OTP-${{ matrix.erlixir.otp-version }}
      #OPENSSL_HASH: 002a2d6b30b58bf4bea46c43bdd96365aaf8daa6c428782aa4feee06da197df3
      #OPENSSL_VERSION: 3.4.1

    name: "Build iOS runtime"
    runs-on: "macos-latest"
    steps:
      - run: |
          brew install git carthage coreutils
          brew unlink openssl@1.1 && brew link openssl@3
          brew info asdf
      - uses: actions/checkout@v4

      - name: Asdf Cache
        uses: actions/cache@v3
        id: asdf-cache
        with:
          path: /Users/runner/.asdf
          key: macos-asdf-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts }}-${{ matrix.erlixir.elixir-version }}

      - name: Setup asdf
        if: steps.asdf-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/asdf-vm/asdf.git ~/.asdf

      - name: Configure erl options
        if: ${{ matrix.erlixir.erl-opts }} != ''
        run: |
          export KERL_CONFIGURE_OPTIONS="${{matrix.erlixir.erl-opts}}"
          # --with-ssl=$(brew --prefix openssl@3) 
          
      - name: Setup elixir
        id: asdf-setup
        if: steps.asdf-cache.outputs.cache-hit != 'true'
        run: |
          . $HOME/.asdf/asdf.sh
          
          asdf plugin add erlang
          asdf plugin add elixir
          echo "erlang ${{matrix.erlixir.otp-version}}" >> .tool-versions
          echo "elixir ${{matrix.erlixir.elixir-version}}" >> .tool-versions
          asdf install erlang
          asdf install elixir

      - name: Save asdf Cache
        if: steps.asdf-cache.outputs.cache-hit != 'true' && steps.asdf-setup.outcome == 'success'
        uses: actions/cache/save@v3
        with:
          path: |
            /Users/runner/.asdf
          key: macos-asdf-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts }}-${{ matrix.erlixir.elixir-version }}

      - name: OTP Cache
        uses: actions/cache@v3
        id: otp-cache
        with:
          path: |
            _build/otp_cache
          key: macos-otp-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts }}
          restore-keys: |
            macos-otp-${{ matrix.erlixir.otp-version }}-
            macos-otp-
      
      - name: Openssl Cache
        uses: actions/cache@v3
        id: openssl-cache
        with:
          path: |
            _build/openssl_cache
          key: macos-openssl-${{env.OPENSSL_VERSION}}
          restore-keys: 
            macos-openssl-

      - name: Build iOS runtime
        id: build-ios
        env: 
          PARALLEL: "true"
        run:  |
          . $HOME/.asdf/asdf.sh
          mix package.ios.runtime

      - name: Info Openssl
        shell: bash
        continue-on-error: true
        run: |
          ls -lah _build/ci_openssl || true
          find . -name openssl

      - name: Save Openssl Cache
        uses: actions/cache/save@v3
        if: steps.openssl-cache.outputs.cache-hit != 'true'
        # && steps.build-ios.outcome == 'success'
        with:
          path: |
            _build/openssl_cache
          key: macos-openssl-${{env.OPENSSL_VERSION}}

      - name: Save OTP Cache
        uses: actions/cache/save@v3
        id: otp-cache-save
        with:
          path: |
            _build/otp_cache
          key: macos-otp-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts }}

      - name: Restructure dir for iOS artifact
        shell: bash
        run: |
          mkdir ${{github.workspace}}/_build/ios-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}-runtime.xcframework
          ls -lah _build
          cp _build/liberlang.xcframework ${{github.workspace}}/_build/ios-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}-runtime.xcframework/

      - name: Archive runtimes
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}-runtime.xcframework.zip
          #path: _build/liberlang.xcframework
          path: ${{github.workspace}}/_build/ios-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}-runtime.xcframework

      - name: Generate iOS Checksums and Release Notes
        id: ios-checksums
        run: |
          cd _build
          # For GNU systems.
          if command -v sha256sum >/dev/null 2>&1; then
              find . -name "*.xcframework.zip" -print0 | while IFS= read -r -d $'\0' file; do
                sha256sum "$file" >> checksums.txt
              done
          # For BSD systems
          else
              find . -name "*.xcframework.zip" -print0 | while IFS= read -r -d $'\0' file; do
                shasum -a 256 "$file" >> checksums.txt
              done
          fi
          echo "::set-output name=ios_checksums::$(cat checksums.txt)"
          cd ..

      - name: iOS release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          #files: _build/liberlang.xcframework
          files: ios-${{ matrix.erlixir.otp-version }}-erl-opts-${{matrix.erlixir.erl-opts}}-${{ matrix.erlixir.elixir-version }}-runtime.xcframework.zip
          body: |
            iOS Checksums:
            ${{ steps.ios-checksums.outputs.ios_checksums }}
